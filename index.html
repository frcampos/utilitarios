<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Compressor de Imagens</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container my-4">
        <h1 class="mb-4">Compressor e Conversor de Imagens</h1>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="files" class="form-label">Selecionar imagens (até 30) ou limite do servidor:</label>
                <input class="form-control" type="file" id="files" name="files" accept=".png,.jpg,.jpeg" multiple required />
            </div>

            <div class="mb-3">
                <label for="zip_file" class="form-label">Ou carregar ficheiro ZIP:</label>
                <input class="form-control" type="file" id="zip_file" name="zip_file" accept=".zip" />
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-2">
                    <label for="quality" class="form-label">Qualidade (%)</label>
                    <input type="number" class="form-control" id="quality" name="quality" min="1" max="100" value="75" />
                </div>
                <div class="col-md-2">
                    <label for="resize" class="form-label">Redimensionar (%)</label>
                    <input type="number" class="form-control" id="resize" name="resize" min="1" max="1000" value="100" />
                </div>
                <div class="col-md-2">
                    <label for="width" class="form-label">Largura (px)</label>
                    <input type="number" class="form-control" id="width" name="width" min="1" placeholder="Opcional" />
                </div>
                <div class="col-md-2">
                    <label for="height" class="form-label">Altura (px)</label>
                    <input type="number" class="form-control" id="height" name="height" min="1" placeholder="Opcional" />
                </div>
                <div class="col-md-2">
                    <label for="dpi" class="form-label">DPI</label>
                    <input type="number" class="form-control" id="dpi" name="dpi" min="1" value="72" />
                </div>
                <div class="col-md-2">
                    <label for="output_format" class="form-label">Formato de saída</label>
                    <select class="form-select" id="output_format" name="output_format">
                        <option value="original" selected>Original</option>
                        <option value="jpg">JPG</option>
                        <option value="png">PNG</option>
                        <option value="both">Ambos</option>
                    </select>
                </div>
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" value="true" id="ocultar_faces" name="ocultar_faces" />
                <label class="form-check-label" for="ocultar_faces">
                    Ocultar rostos (mascarar faces)
                </label>
            </div>

            <div class="mb-3">
                <button type="submit" class="btn btn-primary me-2">Comprimir</button>
                <button type="button" id="resetBtn" class="btn btn-secondary">Limpar formulário</button>
            </div>

            <div id="progress" class="mb-3" style="display:none;">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                        style="width: 0%" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
            </div>

            <div id="message" class="mb-3"></div>
        </form>
    </div>

    <footer class="text-center mt-4 mb-3">
        <small>
            &copy; Fernando Rui Campos  - Ferramenta de conversão e proteção privacidade em imagens (experimental) - Criação: 10 de junho 2025 - Atualização: 11 de junho 2025
        </small>
    </footer>

    <script>
    const form = document.getElementById('uploadForm');
    const filesInput = document.getElementById('files');
    const zipInput = document.getElementById('zip_file');
    const progressBar = document.querySelector('.progress-bar');
    const progressContainer = document.getElementById('progress');
    const message = document.getElementById('message');
    const resetBtn = document.getElementById('resetBtn');

    const apiUrl = 'https://compressor-api.onrender.com/upload';  // ajusta conforme necessário

    // Bloquear inputs mutuamente
    filesInput.addEventListener('change', () => {
        if (filesInput.files.length > 0) {
            zipInput.disabled = true;
            zipInput.value = "";
        } else {
            zipInput.disabled = false;
        }
    });

    zipInput.addEventListener('change', () => {
        if (zipInput.files.length > 0) {
            filesInput.disabled = true;
            filesInput.value = "";
        } else {
            filesInput.disabled = false;
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        message.textContent = '';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressContainer.style.display = 'block';

        const formData = new FormData(form);

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Erro no servidor');
            }

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'imagens_comprimidas.zip';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            message.textContent = 'Ficheiros processados com sucesso!';
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';

        } catch (error) {
            message.textContent = 'Erro: ' + error.message;
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
        }
    });

    resetBtn.addEventListener('click', () => {
        form.reset();
        message.textContent = '';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressContainer.style.display = 'none';
        filesInput.disabled = false;
        zipInput.disabled = false;
    });
</script>

</body>
</html>
