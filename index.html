<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Compressor de Imagens</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">

  <div class="container">
    <h2 class="mb-4">Compressor de Imagens (.png/.jpg)</h2>

    <form id="uploadForm">
      <div class="mb-3">
        <label for="files" class="form-label">Seleciona imagens (até 30 ou 1 ficheiro .zip)</label>
        <input class="form-control" type="file" id="files" name="files" multiple accept=".png,.jpg,.jpeg,.zip">
      </div>

      <div class="mb-3">
        <label class="form-label">Qualidade JPEG (30-90)</label>
        <input type="range" class="form-range" min="30" max="90" value="60" id="quality">
        <span id="qualityValue">60</span>
      </div>

      <div class="mb-3">
        <label class="form-label">Reduzir tamanho (escala entre 0.1 e 1.0)</label>
        <input type="number" step="0.1" min="0.1" max="1.0" value="1.0" class="form-control" id="resize">
      </div>

      <div class="mb-3">
        <label class="form-label">Largura fixa (px)</label>
        <input type="number" min="0" class="form-control" id="width" value="0">
      </div>

      <div class="mb-3">
        <label class="form-label">Altura fixa (px)</label>
        <input type="number" min="0" class="form-control" id="height" value="0">
      </div>

      <button type="submit" class="btn btn-primary">Comprimir</button>
    </form>

    <div class="progress mt-4" style="height: 25px;">
      <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
    </div>

    <div id="result" class="mt-3"></div>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const progressBar = document.getElementById("progressBar");
    const result = document.getElementById("result");
    const qualitySlider = document.getElementById("quality");
    const qualityValue = document.getElementById("qualityValue");

    qualitySlider.oninput = () => {
      qualityValue.innerText = qualitySlider.value;
    };

    form.onsubmit = async (e) => {
      e.preventDefault();
      result.innerHTML = "";
      progressBar.style.width = "10%";
      progressBar.innerText = "A processar...";

      const formData = new FormData();
      const files = document.getElementById("files").files;
      if (files.length === 0) {
        result.innerHTML = '<div class="alert alert-danger">Seleciona pelo menos 1 ficheiro.</div>';
        return;
      }

      if (files.length === 1 && files[0].name.endsWith(".zip")) {
        formData.append("zip_file", files[0]);
      } else {
        for (let i = 0; i < files.length; i++) {
          formData.append("files", files[i]);
        }
      }

      // Parâmetros opcionais
      formData.append("quality", document.getElementById("quality").value);
      formData.append("resize", document.getElementById("resize").value);
      formData.append("width", document.getElementById("width").value);
      formData.append("height", document.getElementById("height").value);

      try {
        const response = await fetch("https://compressor-api.onrender.com/upload", {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Erro ao processar ficheiros.");
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "imagens_comprimidas.zip";
        document.body.appendChild(link);
        link.click();
        link.remove();

        progressBar.style.width = "100%";
        progressBar.innerText = "Concluído!";
        result.innerHTML = '<div class="alert alert-success">Download concluído com sucesso.</div>';

      } catch (err) {
        progressBar.style.width = "0%";
        progressBar.innerText = "Erro";
        result.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      }
    };
  </script>
</body>
</html>
