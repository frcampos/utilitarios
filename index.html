<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compressor de Imagens</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4 text-center">Compressor de Imagens</h2>

    <form id="uploadForm">
      <div class="mb-3">
        <label for="files" class="form-label">Selecionar imagens (até 30) ou ficheiro ZIP:</label>
        <input type="file" class="form-control" id="files" name="files" multiple accept=".png,.jpg,.jpeg,.zip" />
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label for="quality" class="form-label">Qualidade JPEG (30–90):</label>
          <input type="number" class="form-control" id="quality" name="quality" value="75" min="30" max="90" />
        </div>
        <div class="col-md-4">
          <label for="resize" class="form-label">Escala de Redução (0.1–1.0):</label>
          <input type="number" class="form-control" id="resize" name="resize" step="0.1" value="1.0" min="0.1" max="1.0" />
        </div>
        <div class="col-md-2">
          <label for="width" class="form-label">Largura (px):</label>
          <input type="number" class="form-control" id="width" name="width" min="0" />
        </div>
        <div class="col-md-2">
          <label for="height" class="form-label">Altura (px):</label>
          <input type="number" class="form-control" id="height" name="height" min="0" />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label for="output_format" class="form-label">Formato de saída:</label>
          <select class="form-select" id="output_format" name="output_format">
            <option value="original">Manter formato original</option>
            <option value="jpg">Converter para JPG</option>
            <option value="png">Converter para PNG</option>
            <option value="both">Gerar ambos (original + convertido)</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="dpi" class="form-label">DPI (resolução):</label>
          <input type="number" class="form-control" id="dpi" name="dpi" min="72" max="600" placeholder="Opcional" />
        </div>
      </div>

      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">Comprimir</button>
        <button type="button" class="btn btn-secondary" onclick="limparFormulario()">Limpar</button>
      </div>
    </form>

    <div id="progresso" class="mt-4"></div>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const progresso = document.getElementById("progresso");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      progresso.innerHTML = "<div class='text-info'>A processar...</div>";

      const formData = new FormData(form);
      const files = document.getElementById("files").files;
      let zipFile = null;

      for (let i = 0; i < files.length; i++) {
        if (files[i].name.endsWith(".zip")) {
          zipFile = files[i];
          break;
        }
      }

      if (zipFile) {
        formData.delete("files");
        formData.append("zip_file", zipFile);
      }

      try {
        const response = await fetch("https://compressor-api.onrender.com/upload", {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          const erro = await response.json();
          progresso.innerHTML = `<div class="alert alert-danger">Erro: ${erro.error}</div>`;
          return;
        }

        const blob = await response.blob();
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "imagens_comprimidas.zip";
        link.click();
        progresso.innerHTML = `<div class="alert alert-success">Ficheiros comprimidos com sucesso.</div>`;
      } catch (err) {
        progresso.innerHTML = `<div class="alert alert-danger">Erro ao processar ficheiros.</div>`;
      }
    });

    function limparFormulario() {
      document.getElementById("uploadForm").reset();
      document.getElementById("files").value = "";
      progresso.innerHTML = "";
    }
  </script>
</body>
</html>
