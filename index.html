<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Compressor de Imagens</title>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 600px; margin: auto; }
    #progress { width: 100%; height: 20px; background: #eee; margin-top: 1em; }
    #bar { height: 100%; width: 0%; background: #4caf50; text-align: center; color: white; }
    table { width: 100%; margin-top: 1em; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  </style>
</head>
<body>
  <h2>Compressor de Imagens</h2>
  <input type="file" id="input" multiple accept="image/png, image/jpeg">
  <button onclick="upload()">Enviar e Comprimir</button>
  <div id="progress"><div id="bar">0%</div></div>
  <div id="result"></div>

  <script>
    async function upload() {
      const input = document.getElementById('input');
      const files = input.files;
      if (!files.length) return alert("Seleciona pelo menos um ficheiro.");

      if (files.length > 10) return alert("Máximo permitido: 10 ficheiros.");

      const formData = new FormData();
      for (const file of files) {
        formData.append('files', file);
      }

      const bar = document.getElementById("bar");
      bar.style.width = "0%";
      bar.textContent = "0%";

      const res = await fetch("https://compressor-api.onrender.com/upload", {
        method: "POST",
        body: formData
      });

      if (!res.ok) {
        const error = await res.json();
        alert(error.error || "Erro desconhecido ao processar.");
        return;
      }

      const contentType = res.headers.get("Content-Type");
      if (contentType.includes("application/json")) {
        const data = await res.json();
        mostrarEstatisticas(data.stats);
      } else {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "imagens_comprimidas.zip";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      bar.style.width = "100%";
      bar.textContent = "100%";
    }

    function mostrarEstatisticas(stats) {
      const div = document.getElementById("result");
      let html = "<h3>Estatísticas</h3><table><tr><th>Ficheiro</th><th>Original (KB)</th><th>Comprimido (KB)</th></tr>";
      for (const s of stats) {
        html += `<tr><td>${s.ficheiro}</td><td>${s.original_kb}</td><td>${s.comprimido_kb}</td></tr>`;
      }
      html += "</table>";
      div.innerHTML = html;
    }
  </script>
</body>
</html>
